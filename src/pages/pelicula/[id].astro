---
//Objeto que contiene valores de segmentos de ruta dinámica que coincidan con esta petición
import Layout from '../../layouts/Layout.astro';
export async function getStaticPaths(){
    const res= await fetch (`https://api.themoviedb.org/3/movie/now_playing?api_key=de6d4ae5a295146cc6e2d05c638d7b7c&language=es-ES`);
    const data = await res.json();
    const films = data.results;

    const paths = films.map((film: { id: { toString: () => any; }; })=>({
        params: {id: film.id.toString()}
    }));

    return paths;
}

const {id} = Astro.params;

const filmRes= await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=de6d4ae5a295146cc6e2d05c638d7b7c&language=es-ES`);
const film = await filmRes.json();

const pageTitle = "Goodfilming -" + film.title


const YT_API_KEY = "AIzaSyB_X8Q35iwKpgcXtHanHyq5wRz3nw_C7EU";
const ytQuery = encodeURIComponent(`${film.title} trailer español`);
const ytUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${ytQuery}&type=video&key=${YT_API_KEY}&maxResults=1`;

const ytRes = await fetch (ytUrl);
const ytData = await ytRes.json();
let videoId = null;
if(ytData.items && ytData.items.length >0){
    videoId= ytData.items[0].id.videoId;
}


const vote_average = film.vote_average;
let vote_averageParaMostrar = Math.round(vote_average*10)/10;


---

<Layout pageTitle={pageTitle}>
    <h1>{film.title}</h1>
    <div class="nowPlayingTextContainer">
        <img class="imgFilm" src={`https://image.tmdb.org/t/p/w200${film.poster_path}`} alt="{pelicula.title}">
        <div>
            <div class="synopsisContainer">
                <h4 class="heading">Sinopsis:</h4>
                <p class="overview">{film.overview}</p>
            </div>
            <div class="rating">
                <p>Nota media: </p>
                <p> ⭐ {vote_averageParaMostrar}<strong> / 10</strong></p>
            </div>
             <!--Añadir para que el usuario evalue y la media de valoraciones de goodfilming -->
        </div>
    </div>
        <h4 class="heading">Trailer:</h4>
        {videoId ? (
            <iframe 
            width="700"
            height="400"
            src={`https://www.youtube.com/embed/${videoId}`}
            title={`Trailer de ${film.title}`}
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
            ></iframe>
        ) : (
            <p>No se encontró el trailer</p>
        )}
    </div>
</Layout>
<script>
    document.addEventListener('DOMContentLoaded', function(){
        const overview = document.querySelector(".overview");
        if(!overview.textContent?.trim()){
            overview.textContent = "--------------------------------------------------------------- Sinopsis no disponible --------------------------------------------------------------";
        }
    });
</script>

