---
const BACKEND_HOST = import.meta.env.PUBLIC_BACKEND_HOST;
const {filmId} = Astro.props;
---
<div class="btnContainer">
    <button class="btnSave" data-film-id={filmId}>ðŸ’¾ Guardar pelÃ­cula</button>
    <p id="errorMessage" class="error"></p>
    <p id="successfulMessage" class="success"></p>
</div>

<script type="module" define:vars={{ BACKEND_HOST }}>

document.addEventListener("DOMContentLoaded", () =>{
    const errorMessage = document.getElementById("errorMessage");
    const successfulMessage = document.getElementById("successfulMessage");
    const token = localStorage.getItem("token");
    const buttons = document.querySelectorAll(".btnSave");
    buttons.forEach(button =>{
        button.addEventListener("click", async()=>{
    
            const filmId = button.dataset.filmId;
            if(!token){
                    window.location.href = "/logInPage";
                    return;
                }
            try{
                const res = await fetch(`${BACKEND_HOST}/watchlist?id_pelicula=${filmId}`, {
                    method: "POST",
                    headers: { 
                       'Authorization': `Bearer ${token}` 
                    },
                    credentials: 'include',
                });
                const result = await res.json();
                if(res.ok){
                    successfulMessage.textContent= "Guardado";
                }else{
                    errorMessage.textContent = "PelÃ­cula ya registrada";
                }

            }catch(error){
                errorMessage.textContent = result.message || "Error de conexiÃ³n con el servidor o red";
            }
        });
    });
});

</script>